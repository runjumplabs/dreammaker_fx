<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>DreamMaker FX Sketch</title>

	<link rel="stylesheet"
	      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/default.min.css">

	
</head>
<body>

<pre><code class="arduino"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"dm_fx.h"</span></span>

<span class="hljs-comment">/**
 Multiband compressor example uses two compressors which each act on a certain
 band of the signal.
 
                   +--------+     +------------+    +-------+
                   |        |     |            |    |       |
              +---&gt;+  HPF   +----&gt;+ Compressor +---&gt;+       |
              |    |        |     |            |    |       |
              |    +--------+     +------------+    |       |
Instr In +----+                                     | Mixer +----&gt; Amp Out
              |    +--------+     +------------+    |       |
              |    |        |     |            |    |       |
              +---&gt;+  LPF   +----&gt;+ Compressor +---&gt;+       |
                   |        |     |            |    |       |
                   +--------+     +------------+    +-------+

Created with http://asciiflow.com/

 */</span>


<span class="hljs-function">fx_compressor <span class="hljs-title">comp_upper</span><span class="hljs-params">( <span class="hljs-number">-30.0</span>,    <span class="hljs-comment">// Threshold in dB</span>
                          <span class="hljs-number">8</span>,        <span class="hljs-comment">// Ratio (1:8)</span>
                          <span class="hljs-number">10.0</span>,     <span class="hljs-comment">// Attack (10ms)</span>
                          <span class="hljs-number">100.0</span>,    <span class="hljs-comment">// Release (100ms)</span>
                          <span class="hljs-number">2.0</span>)</span></span>;     <span class="hljs-comment">// Output gain (2x);</span>

<span class="hljs-function">fx_compressor <span class="hljs-title">comp_lower</span><span class="hljs-params">( <span class="hljs-number">-40.0</span>,    <span class="hljs-comment">// Threshold in dB</span>
                          <span class="hljs-number">32</span>,        <span class="hljs-comment">// Ratio (1:8)</span>
                          <span class="hljs-number">10.0</span>,     <span class="hljs-comment">// Attack (10ms)</span>
                          <span class="hljs-number">100.0</span>,    <span class="hljs-comment">// Release (100ms)</span>
                          <span class="hljs-number">2.0</span>)</span></span>;     <span class="hljs-comment">// Output gain (2x);</span>

<span class="hljs-function">fx_biquad_filter  <span class="hljs-title">crossover_filt_lower</span><span class="hljs-params">(<span class="hljs-number">400.0</span>,             <span class="hljs-comment">// 400.0 Hz</span>
                                       FILTER_WIDTH_WIDE, 
                                       BIQUAD_TYPE_LPF)</span></span>;  <span class="hljs-comment">// Lowpass</span>
<span class="hljs-function">fx_biquad_filter  <span class="hljs-title">crossover_filt_upper</span><span class="hljs-params">(<span class="hljs-number">400.0</span>,             <span class="hljs-comment">// 400.0 Hz</span>
                                       FILTER_WIDTH_WIDE, 
                                       BIQUAD_TYPE_HPF)</span></span>;  <span class="hljs-comment">// Highpass</span>

fx_mixer_2 mixer;

<span class="hljs-keyword">bool</span>  effect_bypassed = <span class="hljs-literal">false</span>;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// put your setup code here, to run once:</span>

  pedal.init();

  pedal.route_audio(pedal.instr_in, crossover_filt_lower.input);
  pedal.route_audio(pedal.instr_in, crossover_filt_upper.input);

  pedal.route_audio(crossover_filt_lower.output, comp_lower.input);
  pedal.route_audio(crossover_filt_upper.output, comp_upper.input);

  pedal.route_audio(comp_lower.output, mixer.input_1);
  pedal.route_audio(comp_upper.output, mixer.input_2);

  pedal.route_audio(mixer.output, pedal.amp_out);

  pedal.run();

  <span class="hljs-comment">// pedal on initially</span>
  digitalWrite(PIN_FOOTSW_LED_1, HIGH); <span class="hljs-comment">// Turn on LED</span>
    
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// put your main code here, to run repeatedly:</span>

  <span class="hljs-comment">// Add an event if pot 0 has changed</span>
  <span class="hljs-keyword">if</span> (pedal.pot_0.has_changed()) { 

    <span class="hljs-comment">// Pot 0 changes the cross over frequency of the filters</span>
    crossover_filt_lower.set_freq(<span class="hljs-number">100.0</span> + <span class="hljs-number">1000.0</span>*pedal.pot_0.val);
    crossover_filt_upper.set_freq(<span class="hljs-number">100.0</span> + <span class="hljs-number">1000.0</span>*pedal.pot_0.val);
    Serial.print(<span class="hljs-string">"Crossover changed to: "</span>);
    Serial.print(<span class="hljs-number">100.0</span> + <span class="hljs-number">1000.0</span>*pedal.pot_0.val);
    Serial.println(<span class="hljs-string">"Hz"</span>);
    
  } 

  <span class="hljs-comment">// Add an event if pot 1 has changed</span>
  <span class="hljs-keyword">if</span> (pedal.pot_1.has_changed()) { 
    comp_upper.set_attack(pedal.pot_1.val*<span class="hljs-number">100.0</span> + <span class="hljs-number">10.0</span>);
    comp_lower.set_attack(pedal.pot_1.val*<span class="hljs-number">100.0</span> + <span class="hljs-number">10.0</span>);

    Serial.print(<span class="hljs-string">"Attack changed to: "</span>);
    Serial.print(pedal.pot_1.val*<span class="hljs-number">100.0</span> + <span class="hljs-number">10.0</span>);
    Serial.println(<span class="hljs-string">"ms"</span>);
  } 

  <span class="hljs-comment">// Add an event if pot 2 has changed (DOESN'T WORK ON FIRST GEN HARDWARE YET)</span>
  <span class="hljs-keyword">if</span> (pedal.pot_2.has_changed()) { 
    comp_upper.set_threshold(<span class="hljs-number">-12.0</span> - (pedal.pot_2.val*<span class="hljs-number">60</span>));
    comp_lower.set_threshold(<span class="hljs-number">-12.0</span> - (pedal.pot_2.val*<span class="hljs-number">60</span>));

    comp_upper.set_output_gain(<span class="hljs-number">2</span> + pedal.pot_2.val*<span class="hljs-number">15</span>);
    comp_lower.set_output_gain(<span class="hljs-number">2</span> + pedal.pot_2.val*<span class="hljs-number">15</span>);

    Serial.print(<span class="hljs-string">"Sustain changed to: "</span>);
    Serial.println(pedal.pot_2.val);

  } 

  <span class="hljs-comment">// Service </span>
  pedal.service();

  <span class="hljs-comment">// Check if bypass status has changed and update LEDs</span>
  <span class="hljs-keyword">if</span> (effect_bypassed) {
    digitalWrite(PIN_FOOTSW_LED_1, LOW);  <span class="hljs-comment">// Turn off LED</span>
  } <span class="hljs-keyword">else</span> {
    digitalWrite(PIN_FOOTSW_LED_1, HIGH);  <span class="hljs-comment">// Turn off LED</span>
  }
  

}

<span class="hljs-comment">// Footswitch 1 - typically used for enable/bypass</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">footswitch_1_pressed</span><span class="hljs-params">()</span> </span>{ 
  
  <span class="hljs-comment">// Bypass code</span>
  <span class="hljs-keyword">if</span> (effect_bypassed) {
    <span class="hljs-comment">// If we are currently bypassed, switch pedal to active mode and turn on LED next to SW1</span>
    pedal.enable_fx();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// If we are currently active, switch pedal to bypassed mode and turn off LED next to SW1</span>
    pedal.bypass_fx();
  }
  effect_bypassed = !effect_bypassed; <span class="hljs-comment">// Toggle bypassed state variable</span>
}
</code></pre>

</body>	
	<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
</html>
